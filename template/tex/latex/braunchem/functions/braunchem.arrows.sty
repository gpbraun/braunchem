%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   CHEMISTRY FILE IDENTIFICATION                        
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
\ProvidesExplFile{braunchem.arrows}{2021/07/22}{2.2}%
{ BraunChem - Chemistry arrows }
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   ARROW KEYS            
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
\dim_new:N    \l_bchem_arrow_len_dim
\dim_const:Nn \c_bchem_arrow_base_len_dim   { 4.00 em }
\dim_const:Nn \c_bchem_arrow_base_shift_dim { 0.35 em }
 
%% Set how the arrow is printed
\keys_define:nn { braun/chem/arrow }
    {
        style .tl_set:N  = \l_bchem_arrow_style_tl,
        style .initial:n = {->},
 
        len .code:n    = 
            { \dim_set:Nn \l_bchem_arrow_len_dim { #1 \c_bchem_arrow_base_len_dim } },
        len .initial:n = 1,
 
        flip .bool_set:N = \l_bchem_arrow_flip_bool,
        flip .initial:n  = false,
        flip .default:n  = true,
 
        space-before .dim_set:N = \l_bchem_arrow_space_before_dim,
        space-before .initial:n = 1em,
        space-after  .dim_set:N = \l_bchem_arrow_space_after_dim,
        space-after  .initial:n = 1em,
 
        yshift .dim_set:N = \l_bchem_arrow_yshift_dim,
        yshift .initial:n = 0pt,
 
        angle .fp_set:N  = \l_bchem_arrow_angle_fp,
        angle .initial:n = 0.0,
 
        steps .meta:n  = { text/align=l, text/item-first=true, text/xshift=1ex }
    }
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   ARROW COMMAND DEFINITION            
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
\coffin_new:N \l_bchem_arrow_coffin
\seq_new:N \l__bchem_arrow_top_text_seq
\seq_new:N \l__bchem_arrow_bot_text_seq
 
\cs_generate_variant:Nn \seq_set_split:Nnn {NVV}
 
% #1 -> arrow coffin
% #2 -> text
\cs_new_protected:Nn \bchem_arrow_coffin_set:Nn
    {
        %% Set arrow style
        \bchem_arrow_style_set:NV #1 \l_bchem_arrow_style_tl
 
        %% Set arrow text
        \IfNoValueF {#2} { \bchem_arrow_text_join:Nn #1 {#2} }
 
        %% Rotate arrow coffin
        \fp_compare:nF { \l_bchem_arrow_angle_fp = 0 }
            { \coffin_rotate:NV #1 \l_bchem_arrow_angle_fp }
    }
 
% #1 -> text
\cs_new_protected:Nn \bchem_arrow_typeset:n
    {
        \skip_horizontal:V \l_bchem_arrow_space_before_dim
 
        \bchem_arrow_coffin_set:Nn \l_bchem_arrow_coffin {#1}
        
        \coffin_typeset:Nnnnn \l_bchem_arrow_coffin { l } { \l_bchem_arrow_coffin-vc } {-0.5pt} {\c_bchem_arrow_base_shift_dim }
 
        \skip_horizontal:V \l_bchem_arrow_space_after_dim
    }
\cs_generate_variant:Nn \skip_horizontal:n {V}
 
\NewDocumentCommand \arrow { o m o o }
    { 
        \group_begin:
            \BraunNoWarning
            \IfNoValueF {#1} { \keys_set:nn { braun/chem/arrow }  {#1} }
            \IfNoValueF {#2} { \tl_set:Nn \l_bchem_arrow_style_tl {#2} }
            \bchem_arrow_typeset:n {#3}
        \group_end:
    }
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   ARROW TEXT    
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
%% Set the arrow text
\keys_define:nn { braun/chem/arrow/text }
    {
        xshift .dim_set:N  = \l_bchem_arrow_text_xshift_dim,
        xshift .initial:n  = 0pt,
 
        top-yshift .dim_set:N = \l_bchem_arrow_text_top_yshift_dim,
        top-yshift .initial:n = 1ex,
        bot-yshift .dim_set:N = \l_bchem_arrow_text_bot_yshift_dim,
        bot-yshift .initial:n = 1ex,
 
        align .tl_set:N  = \l_bchem_arrow_text_align_tl,
        align .initial:n = c,
 
        line-break .tl_set:N  = \l_bchem_arrow_line_break_tl,
        line-break .initial:n = \\,
 
        font .tl_set:N  = \l_bchem_arrow_text_font_tl,
        font .initial:n = \small\sffamily,
 
        item-first .bool_set:N = \l_bchem_arrow_item_first_bool,
        item-first .initial:n  = false,
        item-first .default:n  = true,
    }
 
%============================================================%
%   SPLIT TEXT BETWEEN LINEBREAKS
%============================================================%
 
\cs_set_protected:Nn \bchem_arrow_text_split:nNN 
    {
        \seq_set_split:NVn #2 \l_bchem_arrow_line_break_tl {#1}
        \seq_remove_all:Nn #2 {}
        %% Split lines in half
        \bool_while_do:nn 
            { \int_compare_p:n { \seq_count:N #2 > \seq_count:N #3 } }
            {
                \seq_pop:NNT #2 \l_tmpa_tl { \seq_put_right:NV #3 \l_tmpa_tl }
            }
    }
 
\cs_generate_variant:Nn \seq_set_split:Nnn { NVn }
 
%============================================================%
%   ATTACH TEXT TO ARROW
%============================================================%
 
\newcounter { arrow_text_item }
 
% #1 -> arrow coffin
% #2 -> text
\cs_new:Nn \bchem_arrow_text_join:Nn
    {
        \group_begin:
            \setcounter { arrow_text_item } { 0 }
 
            %% Redefine \item localy
            \cs_set:Npn \bchem_arrow_item:
                { 
                    \refstepcounter { arrow_text_item } 
                    \arabic         { arrow_text_item } . ~ 
                }
 
            \bchem_arrow_text_split:nNN {#2} \l__bchem_arrow_bot_text_seq \l__bchem_arrow_top_text_seq 
 
            %% Top text
            \seq_if_empty:NF \l__bchem_arrow_tmp_top_text_seq
                { 
                    %% Set Molecule
                    \bchem_arrow_text_set:NNnn #1 \l__bchem_arrow_top_text_seq {H}{\l_bchem_arrow_text_top_yshift_dim} 
                }
 
            %% Bottom text
            \seq_if_empty:NF \l__bchem_arrow_tmp_bot_text_seq
                { 
                    %% Set Molecule
                    \bchem_arrow_text_set:NNnn #1 \l__bchem_arrow_bot_text_seq {t}  {-\l_bchem_arrow_text_bot_yshift_dim}
                }
        \group_end:
    }
 
%============================================================%
%   CREATE ARROW TEXT BOX
%============================================================%
 
\coffin_new:N \l_bchem_arrow_text_coffin
 
% #1 -> arrow text coffin
% #2 -> text seq
% #3 -> vertical position
% #4 -> yshift
\cs_set_protected:Nn \bchem_arrow_text_set:NNnn
    {
        \group_begin:
            \vcoffin_set:Nnn \l_tmpa_coffin
                { \l_bchem_arrow_len_dim - \l_bchem_arrow_text_xshift_dim }
                {
                    \str_case:Vn \l_bchem_arrow_text_align_tl
                        {
                            { c }{ \centering   } 
                            { l }{ \raggedright }
                            { r }{ \raggedleft  } 
                        } 
                    \tl_use:N \l_bchem_arrow_text_font_tl 
                    \bool_if:NTF \l_bchem_arrow_item_first_bool
                        {
                            \bchem_arrow_item: 
                            \seq_use:Nn {#2} { \\ \bchem_arrow_item: }
                        }
                        { 
                            \seq_use:Nn {#2} { \\ } 
                        }
                }
            \seq_clear:N #2
            %% Join text and arrow
            \coffin_gjoin:NenNnnnn #1 
                { #1 - \bool_if:NTF \l_bchem_arrow_flip_bool {l}{r} } { #1-vc }
                \l_tmpa_coffin  {r} {#3} { 0pt } {#4}
        \group_end:
    }
 
\cs_generate_variant:Nn \coffin_gjoin:NnnNnnnn   {NenNnnnn}
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   ARROW BODY              
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
\box_new:N \l__bchem_arrow_body_coffin
 
% #1 -> arrow box coffin
% #2 -> arrow style
\cs_new:Nn \bchem_arrow_style_set:Nn
{
    %% Arrow styles
    \hbox_set:Nn \l__bchem_arrow_body_coffin
        { \prop_item:Nn \l_bchem_arrow_styles_prop {#2} }
 
    %% Set arrow coffin
    \hcoffin_set:Nn #1 { \box_use_drop:N \l__bchem_arrow_body_coffin }
 
    \coffin_set_horizontal_pole:Nnn #1 { #1-vc } { \coffin_ht:N #1/2 }
    \coffin_set_vertical_pole:Nnn   #1 { #1-r  } { \coffin_wd:N #1   }
    \coffin_set_vertical_pole:Nnn   #1 { #1-l  } { 0pt }
 
    %% Flip coffin
    \bool_if:NT \l_bchem_arrow_flip_bool { \coffin_scale:Nnn #1 { -1 } { 1 } }
}
\cs_generate_variant:Nn \bchem_arrow_style_set:Nn {NV}
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   ARROW STYLES             
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
%% Set how the arrow is drawn
\keys_define:nn { braun/chem/arrow/draw }
    {
        linewidth .dim_set:N = \l_bchem_arrow_lw_dim,
        linewidth .initial:n = 0.06em,
 
        eq-sep .dim_set:N = \l_bchem_arrow_eq_sep_dim,
        eq-sep .initial:n = 0.6ex,
 
        multi-sep .dim_set:N = \l_bchem_arrow_multi_sep_dim,
        multi-sep .initial:n = 1.2ex,
    }
 
%============================================================%
%   ARROW TIPS
%============================================================%
 
%% ARROW TIP
\coffin_new:N   \c_bchem_arrow_tip_coffin
\hcoffin_set:Nn \c_bchem_arrow_tip_coffin
{
    \draw_begin:
        \draw_path_corner_arc:nn { 0.35mm } { 0.35mm }
        \draw_path_moveto:n {  0.0ex,  0.0ex }
        \draw_path_lineto:n { -0.5ex,  0.5ex }
        \draw_path_lineto:n {  0.7ex,  0.0ex }
        \draw_path_lineto:n { -0.5ex, -0.5ex }
        \draw_path_close:
        \draw_path_use_clear:n { fill }
    \draw_end:  
}
\coffin_new:N     \c_bchem_arrow_reversed_tip_coffin
\coffin_set_eq:NN \c_bchem_arrow_reversed_tip_coffin \c_bchem_arrow_tip_coffin
\coffin_scale:Nnn \c_bchem_arrow_reversed_tip_coffin {-1} {+1}
 
%% ARROW HARPOON (For equilibrium arrows)
\coffin_new:N   \c_bchem_arrow_hpn_coffin
\hcoffin_set:Nn \c_bchem_arrow_hpn_coffin
{
    \draw_begin:
        \draw_path_rectangle_corners:nn { -0.5ex, -\l_bchem_arrow_lw_dim/2 } { 0.7ex, 0.5ex }
        \draw_path_use_clear:n { clip }
        \draw_path_corner_arc:nn { 0.35mm } { 0.35mm }
        \draw_path_moveto:n {  0.0ex,  0.0ex }
        \draw_path_lineto:n { -0.5ex,  0.5ex }
        \draw_path_lineto:n {  0.7ex,  0.0ex }
        \draw_path_lineto:n { -0.5ex, -0.5ex }
        \draw_path_close:
        \draw_path_use:n { fill }
    \draw_end:  
}
\coffin_new:N     \c_bchem_arrow_reversed_hpn_coffin
\coffin_set_eq:NN \c_bchem_arrow_reversed_hpn_coffin \c_bchem_arrow_hpn_coffin
\coffin_scale:Nnn \c_bchem_arrow_reversed_hpn_coffin {-1} {-1}
 
\prop_new:N \l_bchem_arrow_styles_prop
 
%============================================================%
%   NOTHING
%============================================================%
 
\prop_put:Nnn \l_bchem_arrow_styles_prop
{ none }{ }
 
%============================================================%
%   STRAIGHT LINE
%============================================================%
 
\prop_put:Nnn \l_bchem_arrow_styles_prop
{ - }
{
    \draw_begin:
        \draw_linewidth:V \l_bchem_arrow_lw_dim
        \draw_path_moveto:n { 0cm , 0cm }
        \draw_path_lineto:n { 0cm , \l_bchem_arrow_len_dim }
        \draw_path_use_clear:n { stroke }
    \draw_end:
}
 
%============================================================%
%   REACTION ARROW
%============================================================%
 
\prop_put:Nnn \l_bchem_arrow_styles_prop
{ -> }
{
    \draw_begin:
        \draw_linewidth:V \l_bchem_arrow_lw_dim
        \draw_path_moveto:n { 0cm , 0cm }
        \draw_path_lineto:n { \l_bchem_arrow_len_dim , 0cm }
        \draw_path_use_clear:n { stroke }
    \draw_end:
    \coffin_typeset:Nnnnn \c_bchem_arrow_tip_coffin {r}{vc}{0.1ex}{\l_bchem_arrow_lw_dim/2}
}
 
%============================================================%
%   EQUILIBRIUM ARROW
%============================================================%
 
\prop_put:Nnn \l_bchem_arrow_styles_prop
{ <=> }
{
    \coffin_typeset:Nnnnn 
        \c_bchem_arrow_reversed_hpn_coffin {r}{b}{0pt}{\l_bchem_arrow_lw_dim}
    \skip_horizontal:n {-1.1ex} % 0.7ex + 0.5ex - 0.1ex
    \draw_begin:
        \draw_linewidth:V \l_bchem_arrow_lw_dim
        \draw_path_moveto:n { 0cm , 0cm }
        \draw_path_lineto:n { \l_bchem_arrow_len_dim , 0cm }
        \draw_path_moveto:n { 0cm , \l_bchem_arrow_eq_sep_dim }
        \draw_path_lineto:n { \l_bchem_arrow_len_dim , \l_bchem_arrow_eq_sep_dim }
        \draw_path_use_clear:n { stroke }
    \draw_end:
    \coffin_typeset:Nnnnn 
        \c_bchem_arrow_hpn_coffin {r}{b}{0.1ex}{\l_bchem_arrow_eq_sep_dim}
}
 
%============================================================%
%   REVERSE ARROW
%============================================================%
 
\prop_put:Nnn \l_bchem_arrow_styles_prop
{ <- }
{  
    \coffin_typeset:Nnnnn 
        \c_bchem_arrow_reversed_tip_coffin {r}{vc}{0pt}{\l_bchem_arrow_lw_dim/2}
    \skip_horizontal:n {-1.1ex} % 0.7ex + 0.5ex - 0.1ex
    \draw_begin:
        \draw_linewidth:V \l_bchem_arrow_lw_dim
        \draw_path_moveto:n { 0cm , 0cm }
        \draw_path_lineto:n { \l_bchem_arrow_len_dim , 0cm }
        \draw_path_use_clear:n { stroke }
    \draw_end:
}
 
%============================================================%
%   RESSONANCE ARROW
%============================================================%
 
\prop_put:Nnn \l_bchem_arrow_styles_prop
{ <-> }
{
    \coffin_typeset:Nnnnn 
        \c_bchem_arrow_reversed_tip_coffin {r}{vc}{0pt}{\l_bchem_arrow_lw_dim/2}
    \skip_horizontal:n {-1.1ex} % 0.7ex + 0.5ex - 0.1ex
    \draw_begin:
        \draw_linewidth:V \l_bchem_arrow_lw_dim
        \draw_path_moveto:n { 0cm , 0cm }
        \draw_path_lineto:n { \l_bchem_arrow_len_dim , 0cm }
        \draw_path_use_clear:n { stroke }
    \draw_end:
    \coffin_typeset:Nnnnn \c_bchem_arrow_tip_coffin {r}{vc}{0.1ex}{\l_bchem_arrow_lw_dim/2}
}
 
%============================================================%
%   MULTIPLE STEP ARROW
%============================================================%
 
\prop_put:Nnn \l_bchem_arrow_styles_prop
{ ->> }
{
    \draw_begin:
        \dim_sub:Nn \l_bchem_arrow_len_dim {\l_bchem_arrow_multi_sep_dim}
        \draw_linewidth:V \l_bchem_arrow_lw_dim
        \draw_path_moveto:n { 0cm , 0cm }
        \draw_path_lineto:n { \l_bchem_arrow_len_dim , 0cm }
        \draw_path_moveto:n { -\l_bchem_arrow_multi_sep_dim , \l_bchem_arrow_multi_sep_dim }
        \draw_path_lineto:n { \l_bchem_arrow_len_dim - \l_bchem_arrow_multi_sep_dim , \l_bchem_arrow_multi_sep_dim }
        \draw_path_use_clear:n { stroke }
    \draw_end:
    \coffin_typeset:Nnnnn 
        \c_bchem_arrow_tip_coffin {r}{vc}{0.1ex}{\l_bchem_arrow_lw_dim/2}
    \coffin_typeset:Nnnnn 
        \c_bchem_arrow_tip_coffin {r}{vc}{0.1ex - \l_bchem_arrow_multi_sep_dim}{\l_bchem_arrow_multi_sep_dim + \l_bchem_arrow_lw_dim/2}
    \skip_horizontal:n {1ex}
}
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   THE END!!!
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%