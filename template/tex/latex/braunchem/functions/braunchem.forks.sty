%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   CHEMISTRY FILE IDENTIFICATION                        
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ProvidesExplFile{braunchem.forks}{2021/07/07}{1.0}%
{ BraunChem - Chemistry forks }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   FORK KEYS            
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\dim_new:N \l_bchem_fork_x_len_dim
\dim_new:N \l_bchem_fork_y_len_dim

\seq_new:N \l__bchem_tmp_fork_arrow_seq
\seq_new:N \l__bchem_tmp_fork_len_seq

% #1 -> clist with arrow styles ex: (-,->,->)
\cs_set:Nn \bchem_set_fork_arrows:n
{
    \seq_set_split:Nnn \l__bchem_tmp_fork_arrow_seq {,} {#1}
    \tl_set:Nx \l_bchem_fork_mid_arrow_tl 
    { \seq_item:Nn \l__bchem_tmp_fork_arrow_seq {1} }
    \tl_set:Nx \l_bchem_fork_top_arrow_tl 
    { \seq_item:Nn \l__bchem_tmp_fork_arrow_seq {2} }
    \tl_set:Nx \l_bchem_fork_bot_arrow_tl 
    { \seq_item:Nn \l__bchem_tmp_fork_arrow_seq {3} }
}

% #1 -> clist with arrow lenghts ex: (0.2,1,1)
\cs_set:Nn \bchem_set_fork_lens:n
{
    \seq_set_split:Nnn \l__bchem_tmp_fork_len_seq {,} {#1}
    \fp_set:Nn \l_bchem_fork_mid_len_fp 
    { \seq_item:Nn \l__bchem_tmp_fork_len_seq {1} }
    \fp_set:Nn \l_bchem_fork_top_len_fp  
    { \seq_item:Nn \l__bchem_tmp_fork_len_seq {2} }
    \fp_set:Nn \l_bchem_fork_bot_len_fp 
    { \seq_item:Nn \l__bchem_tmp_fork_len_seq {3} }
}

\keys_define:nn { braun/chem/fork }
{
    %% VERTICAL DISTANCE
    dist .code:n    = 
    { \dim_set:Nn \l_bchem_fork_y_len_dim { #1 \c_bchem_arrow_base_len_dim } },
    dist .initial:n = 1,

    %% ANGLE IN DEGREES
    angle .code:n  = 
    { 
        \dim_set:Nx \l_bchem_fork_x_len_dim 
        { \fp_eval:n { tand(#1) } \l_bchem_fork_y_len_dim } 
    },
    angle .initial:n = 15,

    %% MID-ARROW
    mid-style .tl_set:N  = \l_bchem_fork_mid_arrow_tl,
    mid-style .initial:n = {-},
    mid-len   .fp_set:N  = \l_bchem_fork_mid_len_fp,
    mid-len   .initial:n = 1,

    %% TOP-ARROW
    top-style .tl_set:N  = \l_bchem_fork_top_arrow_tl,
    top-style .initial:n = {->},
    top-len   .fp_set:N  = \l_bchem_fork_top_len_fp,
    top-len   .initial:n = 1,

    %% BOT-ARROW
    bot-style .tl_set:N  = \l_bchem_fork_bot_arrow_tl,
    bot-style .initial:n = {->},
    bot-len   .fp_set:N  = \l_bchem_fork_bot_len_fp,
    bot-len   .initial:n = 1,

    %% SET ALL ARROWS
    arrows .code:n  = 
    { \bchem_set_fork_arrows:n {#1} },
    len .code:n  = 
    { \bchem_set_fork_lens:n {#1} },

    %% FLIP ARROW DIRECTION
    flip .bool_set:N = \l_bchem_arrow_flip_bool, % same as arrow!
    flip .default:n  = true,

    %% HORIZONTAL SPACE
    space-before .dim_set:N = \l_bchem_arrow_space_before_dim, % same as arrow!
    space-after  .dim_set:N = \l_bchem_arrow_space_after_dim, % same as arrow!
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   FORK COMMAND DEFINITION            
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\coffin_new:N \l_bchem_fork_coffin

\coffin_new:N \l_bchem_fork_mid_arrow_coffin
\coffin_new:N \l_bchem_fork_top_arrow_coffin
\coffin_new:N \l_bchem_fork_bot_arrow_coffin

% #1 -> fork coffin
% #2 -> mid
% #3 -> top
% #4 -> bot
\cs_new_protected:Nn \bchem_fork_coffin_set:Nnnn
{
    \bchem_fork_style_set:N #1

    \tl_set_eq:NN \l_bchem_arrow_style_tl \l_bchem_fork_mid_arrow_tl
    \dim_set:Nn \l_bchem_arrow_len_dim { \fp_use:N \l_bchem_fork_mid_len_fp \c_bchem_arrow_base_len_dim }
    \bchem_fork_arrow_set:Nnnnn #1 {#2} {vc} {l}{r} 

    \tl_set_eq:NN \l_bchem_arrow_style_tl \l_bchem_fork_top_arrow_tl
    \dim_set:Nn \l_bchem_arrow_len_dim { \fp_use:N \l_bchem_fork_top_len_fp \c_bchem_arrow_base_len_dim }
    \bchem_fork_arrow_set:Nnnnn #1 {#3} {t}  {r}{l} 

    \tl_set_eq:NN \l_bchem_arrow_style_tl \l_bchem_fork_bot_arrow_tl
    \dim_set:Nn \l_bchem_arrow_len_dim { \fp_use:N \l_bchem_fork_bot_len_fp \c_bchem_arrow_base_len_dim }
    \bchem_fork_arrow_set:Nnnnn #1 {#4} {b}  {r}{l}
}

% #1 -> mid
% #2 -> top
% #3 -> bot
\cs_new_protected:Nn \bchem_fork_typeset:nnn
{
    \skip_horizontal:V \l_bchem_arrow_space_before_dim

    \BraunNoWarning

    \bchem_fork_coffin_set:Nnnn \l_bchem_fork_coffin {#1}{#2}{#3}
        
    \coffin_typeset:Nnnnn \l_bchem_fork_coffin
        { l } { \l_bchem_fork_coffin-vc } 
        {-0.5pt} {\c_bchem_arrow_base_shift_dim}

    \skip_horizontal:V \l_bchem_arrow_space_after_dim
}

%% FRONT-END

\NewDocumentCommand \fork
{ o m o m o m o }
{
    \group_begin:
    \IfNoValueF {#1} { \keys_set:nn { braun/chem/fork } {#1} }
    \IfNoValueF {#2} { \tl_set:Nn \l_bchem_fork_mid_arrow_tl {#2} }
    \IfNoValueF {#4} { \tl_set:Nn \l_bchem_fork_top_arrow_tl {#4} }
    \IfNoValueF {#6} { \tl_set:Nn \l_bchem_fork_bot_arrow_tl {#6} }
    \bchem_fork_typeset:nnn {#3}{#5}{#7}
    \group_end:
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   FORK SET ARROW         
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\coffin_new:N \l_bchem_fork_arrow_coffin

% #1 -> fork coffin
% #2 -> top text
% #3, #4, #5 -> coffin poles 
\cs_new:Nn \bchem_fork_arrow_set:Nnnnn
{
    \bchem_arrow_coffin_set:Nn \l_bchem_fork_arrow_coffin {#2}

    %% Join arrow and fork
    \coffin_join:NnnNnnnn #1 { #1-#4 }{ #1-#3 } \l_bchem_fork_arrow_coffin 
        { \l_bchem_fork_arrow_coffin-#5 }{ \l_bchem_fork_arrow_coffin-vc } 
        { 0pt }{ 0pt }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   FORK BODY        
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% #1 -> fork box coffin
\cs_new:Nn \bchem_fork_style_set:N
{
    %% Set fork "<"
    \hcoffin_set:Nn #1
    {
        \draw_begin:
            \draw_linewidth:n { 0.06em }
            \draw_cap_round:
            \draw_path_moveto:n { \l_bchem_fork_x_len_dim , - \l_bchem_fork_y_len_dim }
            \draw_path_lineto:n { 0cm, 0cm }
            \draw_path_lineto:n { \l_bchem_fork_x_len_dim , + \l_bchem_fork_y_len_dim }
            \draw_path_use_clear:n { stroke }
        \draw_end:
        \skip_horizontal:n {-0.85pt}
    }

    % Rotate coffin and handles
    \bool_if:NT \l_bchem_arrow_flip_bool
    { \coffin_scale:Nnn #1 { -1 } { 1 } }
    
    % "hack" to rename poles as #1-l, etc.
    \coffin_join:NnnNnnnn #1 {l}{vc} \c_empty_coffin {r}{vc} {0pt}{0pt}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   STACK COMMAND DEFINITION              
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   THE END!!!
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%