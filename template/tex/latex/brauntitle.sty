%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ______                       _____ _                      %
%  | ___ \                     /  __ \ |                     %
%  | |_/ /_ __ __ _ _   _ _ __ | /  \/ |__   ___ _ __ ___    %
%  | ___ \ '__/ _` | | | | '_ \| |   | '_ \ / _ \ '_ ` _ \   %
%  | |_/ / | | (_| | |_| | | | | \__/\ | | |  __/ | | | | |  %
%  \____/|_|  \__,_|\__,_|_| |_|\____/_| |_|\___|_| |_| |_|  %
%                                                            %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  The BRAUNTITLE Package
%
%          --  Redefining \maketitle  -- 
%
%============================================================%
%
%  GABRIEL P. BRAUN, 2019-2021
%
%============================================================%
%
%  CONTACT: braun.pineschi@gmail.com
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   PACKAGE REQUIREMENTS AND SETUP                   
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage { l3keys2e, l3draw }

\ExplSyntaxOn

\tl_const:Nn \c_brauntitle_date_tl                 {2021/08/11}
\tl_const:Nn \c_brauntitle_version_major_number_tl {6}
\tl_const:Nn \c_brauntitle_version_minor_number_tl {3}
\tl_const:Nn \c_brauntitle_version_subrelease_tl   {a}
\tl_const:Nx \c_brauntitle_version_number_tl
	{
			\c_brauntitle_version_major_number_tl .
			\c_brauntitle_version_minor_number_tl
	}
\tl_const:Nx \c_brauntitle_version_tl
	{
		\c_brauntitle_version_number_tl
		\c_brauntitle_version_subrelease_tl
	}
\tl_const:Nn \c_brauntitle_info_tl { Redefining~ Maketitle }

\ProvidesExplPackage
	{ brauntitle }
	{ \c_brauntitle_date_tl    }
	{ \c_brauntitle_version_tl }
	{ \c_brauntitle_info_tl    }

%============================================================%
%   VARIANTS OF KERNEL FUNCTIONS
%============================================================%

\cs_generate_variant:Nn \dim_compare:nNnF {vNVF}
\cs_generate_variant:Nn \seq_use:Nnnn {cvvv}
\cs_generate_variant:Nn \skip_vertical:n {V}
\cs_generate_variant:Nn \draw_linewidth:n {V}
\cs_generate_variant:Nn \prop_get:NnNTF {NVNTF}
\cs_generate_variant:Nn \box_autosize_to_wd_and_ht:Nnn {NVV}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   TITLE ELEMENTS
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% #1 -> sequence variable
% #2 -> separation
\cs_set:Nn \braun_select_sep:Nn
    {
        \str_case:nn {#2}
            {
                { csv    } { \seq_use:Nn #1   { ,~  } }
                { break  } { \seq_use:Nn #1   { \\  } }
				{ normal } { \seq_use:Nnnn #1 { ~e~ } { ,~ } { ,~e~ } }
				%{numbered-break}
				%{et-al}
            }
    }
\cs_generate_variant:Nn \braun_select_sep:Nn {cv}
\cs_generate_variant:Nn \braun_select_sep:Nn {cn}

% #1 -> text input
% #2 -> text case
\cs_set:Nn \braun_select_case:nn
    {
        \str_case:nnF {#2}
            {
                { upper } { \text_uppercase:n {#1} }
                { lower } { \text_lowercase:n {#1} }
                { title } { \text_titlecase:n {#1} }
                { first } { \text_titlecase_first:n {#1} }
            } {#1}
    }
\cs_generate_variant:Nn \braun_select_case:nn {ev}

% #1 m -> title element name
\NewDocumentCommand \NewTitleElement { o m }
    {
		\seq_new:c  { l_braun_title_#2_value_seq  }
		\bool_new:c { l_braun_title_#2_input_bool }
        \keys_define:nn { braun/maketitle/#2 }
            {
                value .code:n = 
					{ 
						\bool_if:cT { l_braun_title_#2_single_bool }
							{ \seq_clear:c { l_braun_title_#2_value_seq } }
						\seq_put_right:cn { l_braun_title_#2_value_seq } {##1} 
					},
				
				single-value .bool_set:c  = { l_braun_title_#2_single_bool },
				single-value .initial:n   = false,
				single-value .default:n   = true,

                font .tl_set:c   = { l_braun_title_#2_font_tl },

                case .choices:nn = { upper, lower, title, first, none }
                    { \tl_set:cn { l_braun_title_#2_case_tl } {##1} },
                case .initial:n  = first,

                sep .choices:nn = { normal, csv, break }
                    { \tl_set:cn { l_braun_title_#2_sep_tl } {##1} },
                sep .initial:n  = normal,

                sort .bool_set:c = { l_braun_title_#2_sort_bool },
                sort .initial:n  = false,
				sort .default:n  = true,

                pre-text  .tl_set:c = { l_braun_title_#2_pre_text_tl  },
				post-text .tl_set:c = { l_braun_title_#2_post_text_tl },

                before-skip .skip_set:c = { l_braun_title_#2_before_skip },
                before-skip .initial:n  = 0.5em,
				after-skip  .skip_set:c = { l_braun_title_#2_after_skip  },
                after-skip  .initial:n  = 0.5em,
            }
		% Change default keys for the title element
		\IfNoValueF {#1} { \keys_set:nn { braun/maketitle/#2 } {#1} }
        % Set the title element value
        \cs_gset:cpn {#2} ##1 
			{  
				\bool_set_true:c { l_braun_title_#2_input_bool }
				\keys_set:nn { braun/maketitle/#2 }{ value = \exp_not:n {##1} } 
				% LaTeX2e compatibility
				\cs_if_exist:cT {@#2} { \cs_set:cpn {@#2} {##1} } 
			}
        % Print title element value
      	\cs_new:cpn { Print \char_uppercase:N #2 }
            {
				\bool_if:NTF \l_braun_if_maketitle_bool
				{ % inside \maketitle
					\use:c { braun_maketitle_print_#2 }
				}
				{ % outside \maketitle
					\seq_if_empty:cF { l_braun_title_#2_value_seq }
						{
							\braun_select_sep:cn 
								{ l_braun_title_#2_value_seq } { normal } 
						}
				}
            }
		% Print title element value inside \maketitle
		\cs_new:cpn { braun_maketitle_print_#2 }
            {
				\seq_if_empty:cF { l_braun_title_#2_value_seq }
                    {
						\group_begin:
							\dim_compare:vNVF 
								{ l_braun_title_#2_before_skip } = \c_zero_dim
								{
									\skip_vertical:c 
										{ l_braun_title_#2_before_skip }
								}
							\exp_not:n 
								{ \tl_use:c { l_braun_title_#2_font_tl } }
							\tl_use:c  { l_braun_title_#2_pre_text_tl } 
							\braun_select_case:ev
								{ 
									\braun_select_sep:cv
										{ l_braun_title_#2_value_seq } 
										{ l_braun_title_#2_sep_tl    } 
								} 
								{ l_braun_title_#2_case_tl  }
							\tl_use:c { l_braun_title_#2_post_text_tl } 
							\dim_compare:vNVF 
								{ l_braun_title_#2_before_skip } = \c_zero_dim
								{
									\skip_vertical:c 
										{ l_braun_title_#2_after_skip }
								}
						\group_end:
                    }
				\cs_undefine:c { #2 }
			}
    }

%============================================================%
%   DEFAULT TITLE ELEMENTS
%============================================================%

\NewTitleElement 
	[ font = \LARGE\bfseries ] 
	{ title }

\NewTitleElement 
	[ font = \large ]
	{ subtitle }

\NewTitleElement 
	[ font = \large  ]
	{ author }

\NewTitleElement 
	[ sep = break ]
	{ affiliation }

\NewTitleElement 
	[ case = none, single-value ]
	{ date }

\NewTitleElement 
	[ case = lower, font = \ttfamily , before-skip = 0pt, after-skip = 0pt, pre-text = \textnormal{Contato:~} ]
	{ contact }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   LOGO
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\seq_new:N \g_braun_logo_value_seq

\keys_define:nn { braun/maketitle/logo }
	{
		value .code:n = { \seq_put_right:Nn \g_braun_logo_value_seq {#1} },

		height .dim_set:N = \l_braun_logo_height_dim ,
		height .initial:n = 2cm,

		width .dim_set:N = \l_braun_logo_width_dim ,
		width .initial:n = 2cm,
	}

%============================================================%
%   SET LOGO
%============================================================%

% #1 -> logo name/value
\cs_set:Npn \logo #1
    { \keys_set:nn { braun/maketitle/logo } { value = #1 } }

% #1 -> qrcode link
\cs_set:Npn \qrcode #1
    { 
        \RequirePackage { qrcode }
        \seq_put_right:Nn \g_braun_logo_value_seq { \qrcode {#1} }
    }

\coffin_new:N \l_braun_title_logo_r_coffin
\coffin_new:N \l_braun_title_logo_l_coffin

% #1 -> coffin to revieve logo
\cs_set:Npn \braun_set_logo_coffin:N #1
	{
		\group_begin:
			\seq_gpop_left:NNT \g_braun_logo_value_seq \l_tmpa_tl
				{
					\braun_set_logo_box:N \l_tmpa_box
					\hcoffin_gset:Nn #1 { \box_use_drop:N \l_tmpa_box }
				}
		\group_end:
	}
	
%============================================================%
%   PRINT LOGO
%============================================================%

% #1 -> box to recieve logo
\cs_set:Npn \braun_set_logo_box:N #1
{
    \hbox_set:Nn #1
        {
            \group_begin:
                \prop_get:NVNTF \l_braun_logos_prop \l_tmpa_tl \l_tmpb_tl 
                    { \tl_use:N \l_tmpb_tl } 
                    { \tl_use:N \l_tmpa_tl }
            \group_end:
        }
    \box_autosize_to_wd_and_ht:NVV #1 \l_braun_logo_width_dim \l_braun_logo_height_dim
}

% #1 -> logo name/value
\cs_new:Npn \PrintLogo #1 
    {
        \group_begin:
            \braun_set_logo_box:N \l_tmpa_box
            \hcoffin_set:Nn       \l_tmpa_coffin { \box_use_drop:N \l_tmpa_box }
            \coffin_typeset:N     \l_tma_coffin  {l} {H} {0pt} {0pt}
        \group_end:
    }

%============================================================%
%   PREDEFINED LOGOS
%============================================================%

\prop_const_from_keyval:Nn \l_braun_logos_prop
	{
		pensi = 
			\file_input:n { images/logos/pensi/pensi-logo.tex },
		ime = 
			\graphics_include:n { images/logos/ime/ime-logo.pdf },
		ita = 
			\graphics_include:n { images/logos/ita/ita-logo.pdf },
		pesc = 
			\graphics_include:n { images/logos/pesc/pesc-logo.pdf },
		pesc-color = 
			\graphics_include:n { images/logos/pesc/pesc-logo-color.pdf },
		pesc-black = 
			\graphics_include:n { images/logos/pesc/pesc-logo-black.pdf },
	}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   PRINT TITLE            
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\keys_define:nn { braun/maketitle }
	{
		align .choices:nn = { c, l, r }
			{ \tl_set:Nn \l_braun_title_align_tl {#1} },
		align .initial:n  = c,

		print .clist_set:N = \l_braun_title_print_clist,
		print .initial:n   = { title, subtitle, author, affiliation, date },

		pre-text  .tl_set:N = \l_braun_title_pre_text_tl,
		post-text .tl_set:N = \l_braun_title_post_text_tl,

		linewidth .dim_set:N = \g_braun_linewidth_dim,
		linewidth .initial:n =  0.4pt,

		toprule .bool_set:N = \l_braun_title_toprule_bool,
		toprule .initial:n  = false,
		toprule .default:n  = true,
		
		botrule .bool_set:N = \l_braun_title_botrule_bool,
		botrule .initial:n  = false,
		botrule .default:n  = true,

		before-skip .skip_set:N = \l_braun_title_before_skip,
		before-skip .initial:n  = 0.5em,
		after-skip  .skip_set:N = \l_braun_title_after_skip,
		after-skip  .initial:n  = 0.5em,
	}

\ProcessKeysOptions { braun/maketitle }

\cs_set:Npn \BraunNoWarning
    { % avoid badness errors
        \dim_set_eq:NN \vfuzz    \c_max_dim
        \dim_set_eq:NN \hfuzz    \c_max_dim
        \int_set_eq:NN \hbadness \c_max_int
        \int_set_eq:NN \vbadness \c_max_int
    }

% #1 -> footnote text
\cs_set:Npn \BraunThanks #1
    { % equivalent to \thanks
		\tl_if_blank:nF {#1}
		{
			\group_begin:
				\cs_set:Npn \thefootnote { \ensuremath { \star } }
				\footnotetext [ 0 ] {#1}
			\group_end:
		}
		\cs_undefine:N \BraunThanks % save memory
    }

\cs_set:Npn \BraunHRule
    { % print horizontal rule
		\group_begin:
			\BraunNoWarning
			\dim_zero:N \parindent
			\skip_vertical:n {1pt}
			\draw_begin:
				\draw_linewidth:V \g_braun_linewidth_dim
				\draw_path_moveto:n { 0cm , 0cm }
				\draw_path_lineto:n { \linewidth , 0cm }
				\draw_path_use_clear:n { stroke }
			\draw_end:
			\skip_vertical:n {1pt}
		\group_end:
    }

% #1 -> content
\cs_set_protected:Npn \BraunSingleColumn #1
    { \legacy_if:nTF { @twocolumn } { \twocolumn [#1] } {#1} }

%============================================================%
%   \maketitle
%============================================================%

\coffin_new:N \l_braun_title_coffin
\bool_new:N   \l_braun_if_maketitle_bool

\RenewDocumentCommand \maketitle { o }
    {
        \group_begin:
			\bool_set_true:N \l_braun_if_maketitle_bool
			\BraunNoWarning
			\dim_zero:N  \parindent
			\dim_gzero:N \@topnum % Prevents figures from going at top of page.
			% Set keys
			\IfNoValueF {#1} { \keys_set:nn { braun/maketitle } {#1} }
			% Logo coffins
			\str_if_eq:VnTF \l_braun_title_align_tl {r}
				{ % frist logo on the right
					\braun_set_logo_coffin:N \l_braun_title_logo_l_coffin
					\braun_set_logo_coffin:N \l_braun_title_logo_r_coffin
				}
				{ % frist logo on the left
					\braun_set_logo_coffin:N \l_braun_title_logo_r_coffin
					\braun_set_logo_coffin:N \l_braun_title_logo_l_coffin
				}		
			% Main title coffin
			\vcoffin_set:Nnn \l_braun_title_coffin
				{ \textwidth }
				{
					\str_case:Vn \l_braun_title_align_tl
						{
							{ c } { \centering 	 }
							{ l } { \raggedright }
							{ r } { \raggedleft  }
						}
					%% Print title elements specified by \l_braun_title_print_clist
					\clist_map_inline:Nn \l_braun_title_print_clist 
						{ \use:c { braun_maketitle_print_##1 } }
				}
			% Join coffins
			\coffin_join:NnnNnnnn \l_braun_title_coffin {vc} {r}	
				\l_braun_title_logo_r_coffin {vc} {r} {0pt} {0pt}
			\coffin_join:NnnNnnnn \l_braun_title_coffin {vc} {l}	
				\l_braun_title_logo_l_coffin {vc} {l} {0pt} {0pt}
			% Print title
			\BraunSingleColumn
				{
					\tl_use:N        \l_braun_title_pre_text_tl
					\bool_if:NT      \l_braun_title_toprule_bool { \BraunHRule }
					\skip_vertical:V \l_braun_title_before_skip

					\coffin_typeset:Nnnnn \l_braun_title_coffin {l} {vc} {0pt} {0pt}

					\skip_vertical:V \l_braun_title_after_skip
					\bool_if:NT      \l_braun_title_botrule_bool { \BraunHRule }
					\tl_use:N        \l_braun_title_post_text_tl

					\skip_vertical:n { 3em }
				}
			\bool_if:NT \l_braun_title_contact_input_bool
				{ \BraunThanks { \PrintContact } }
        \group_end:
		\cs_undefine:N \maketitle % save memory
    }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   PDF METADATA
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\AtBeginDocument
    {
		\RequirePackage { hyperref }
        \exp_args:Nx \hypersetup
            {
                pdftitle    = \text_purify:n { [\PrintAuthor]~\PrintTitle },
                pdfauthor   = \text_purify:n { \PrintAuthor   },
                pdfsubject  = \text_purify:n { \PrintSubtitle },
                pdfkeywords = Science,
                pdfproducer = Gabriel~Braun,
                pdfcreator  = Gabriel~Braun,
				hidelinks,
				breaklinks  = true,
				urlcolor    = color-1,
            }
    }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   THE END!!!
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOff