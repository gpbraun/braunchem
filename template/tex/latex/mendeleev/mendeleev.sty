%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ______                       _____ _                      %
%  | ___ \                     /  __ \ |                     %
%  | |_/ /_ __ __ _ _   _ _ __ | /  \/ |__   ___ _ __ ___    %
%  | ___ \ '__/ _` | | | | '_ \| |   | '_ \ / _ \ '_ ` _ \   %
%  | |_/ / | | (_| | |_| | | | | \__/\ | | |  __/ | | | | |  %
%  \____/|_|  \__,_|\__,_|_| |_|\____/_| |_|\___|_| |_| |_|  %
%                                                            %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  The MENDELEEV Package
%
%          --  Periodic Table in LaTeX  -- 
%
%============================================================%
%
%  GABRIEL P. BRAUN, 2019-2021
%
%============================================================%
%
%  CONTACT: braun.pineschi@gmail.com
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   PACKAGE REQUIREMENTS AND SETUP                   
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage
{ 
	l3keys2e,
	l3draw,
	siunitx,
	chemmacros,
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   PACKAGE IDENTIFICATION                        
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ProvidesExplPackage{mendeleev}{2020/05/01}{1.0}%
{ Periodic Properties }

%============================================================%
%   VARIANTS OF KERNEL FUNCTIONS
%============================================================%

\cs_generate_variant:Nn \clist_put_right:Nn {Ne}
\cs_generate_variant:Nn \str_lowercase:n {e}
\cs_generate_variant:Nn \color_stroke:n {V}
\cs_generate_variant:Nn \color_fill:n {V}
\cs_generate_variant:Nn \color_select:n {V}
\cs_generate_variant:Nn \draw_linewidth:n {V}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   GET PERIODIC PROPERTIES FROM DATABASE                    
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\file_input:n { mendeleev.elements.sty }

%============================================================%
%   GET PROPERTY FROM ELEMENT SYMBOL/NUMBER
%============================================================%

% #1 -> element symbol
% #2 -> property
\cs_new:Nn \elements_get_property_S:nn % get from symbol
	{ \prop_item:cn { c_elements_#1_prop } {#2} }
\cs_generate_variant:Nn \elements_get_property_S:nn {nV}

% #1 -> element atomic number
% #2 -> property
\cs_new:Nn \elements_get_property_Z:nn % get from number
	{ 
		\prop_item:cn 
			{ c_elements_ \clist_item:Nn \c_elements_clist {#1} _prop } {#2} 
	}
\cs_generate_variant:Nn \elements_get_property_Z:nn {nV}

% #1 -> element symbol/atomic number
% #2 -> property
\cs_new:Npn \GetElementProperty #1 #2 % get from symbol or number
	{
		\regex_match:nnTF {\d} {#1}
			{ \elements_get_property_Z:nn {#1}{#2} }
			{ \elements_get_property_S:nn {#1}{#2} }
	}

%============================================================%
%   ORGANIZE ELEMENT LIST
%============================================================%

\clist_new:N \l__mendeleev_organize_tmp_clist

% #1 -> clist with elements
\cs_set:Nn \mendeleev_organize_elements:N
	{
		\clist_map_inline:Nn #1
			{
				\clist_put_right:Ne \l__mendeleev_organize_tmp_clist 
					{ \elements_get_property_S:nn {##1} { number } }
			}
		\clist_remove_duplicates:N \l__mendeleev_organize_tmp_clist
		\clist_sort:Nn \l__mendeleev_organize_tmp_clist
			{
				\int_compare:nNnTF { ##1 } > { ##2 }
					{ \sort_return_swapped: }
					{ \sort_return_same: }
			}
		\clist_set_eq:NN #1 \l__mendeleev_organize_tmp_clist
	}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   PROPERTY TABLES
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%============================================================%
%   PRINT ELEMENT MOLAR MASS LIST
%============================================================%

% #1 -> clist with elements
\cs_set:Nn \element_ime_mass_line:n
	{	
		\group_begin:

		\clist_set:Nn \l_tmpa_clist {#1}

		\bool_if:NT \l_ptable_row_sort_bool
		{ \mendeleev_organize_elements:N \l_tmpa_clist  }

		\clist_map_inline:Nn \l_tmpa_clist
		{
			\ensuremath
			{
				\chemmacros_chemformula:x 
					{ \elements_get_property_Z:nn {##1}{symbol} } 
				= 
				\qty[round-precision=1,round-mode=places,drop-zero-decimal]{\elements_get_property_Z:nn {##1}{mass}}{u}
				\quad
			}
			
		}

		\group_end:
	}
\cs_generate_variant:Nn \element_ime_mass_line:n  {V}
\cs_generate_variant:Nn \chemmacros_chemformula:n {x}

%============================================================%
%   PRINT ELEMENT TABLE
%============================================================%

% #1 -> elements clist
\cs_set:Npn \ITAMassTable #1
	{
		\group_begin:
			\clist_set:Nn \l_tmpa_clist {#1}
			%% SORTING
			\bool_if:NT \l_ptable_row_sort_bool
				{ \mendeleev_organize_elements:N \l_tmpa_clist  }
			%% SPLIT COLUMNS
			\legacy_if:nTF { @twocolumn } 
				{ \tl_set_eq:NN \l_tmpb_clist \l_tmpa_clist }
				{ % split element list in two
					\bool_while_do:nn 
						{ 
							\int_compare_p:n 
								{ 
									\clist_count:N \l_tmpa_clist > 
									\clist_count:N \l_tmpb_clist 
								} 
						}
						{
							\clist_pop:NNT \l_tmpa_clist \l_tmpa_tl
								{ \clist_put_right:NV \l_tmpb_clist \l_tmpa_tl }
						}
				}
			%% TABLE
			\exp_args:Nx \tabular 
				{ 		
					\legacy_if:nTF { @twocolumn } 
						{
							c 
							S[ table-format = 3   ] 
							S[ table-format = 3.2 ]
						}
						{
							c 
							S[ table-format = 3   ] 
							S[ table-format = 3.2 ]
							c 
							S[ table-format = 3   ] 
							S[ table-format = 3.2 ]
						}
				}
				\toprule
				\legacy_if:nTF { @twocolumn } 
					{ % top header with one column
						{ Elemento    } \c_alignment_token 
						{ Número      } \c_alignment_token 
						{ Massa~Molar } 
					}
					{ % top header with two columns
						{ Elemento    } \c_alignment_token 
						{ Número      } \c_alignment_token 
						{ Massa~Molar } \c_alignment_token 
						{ Elemento    } \c_alignment_token 
						{ Número      } \c_alignment_token 
						{ Massa~Molar }
					}
				\tex_cr:D
				\legacy_if:nTF { @twocolumn } 
					{ % top header with one column
						{ Químico }                   \c_alignment_token 
						{ Atômico }                   \c_alignment_token 
						{ ( \unit { g.mol^{-1} } ) } 
					}
					{  % top header with two columns
						{ Químico }                   \c_alignment_token 
						{ Atômico }                   \c_alignment_token 
						{ ( \unit { g.mol^{-1} } ) }  \c_alignment_token  
						{ Químico }                   \c_alignment_token 
						{ Atômico }                   \c_alignment_token 
						{ ( \unit { g.mol^{-1} } ) } 
					}
				\tex_cr:D
				\midrule 
				\bool_do_until:nn { \clist_if_empty_p:N \l_tmpb_clist }
					{
						\legacy_if:nTF { @twocolumn } 
							{
								\elements_ita_ptable_row:N \l_tmpb_clist
							}
							{
								\elements_ita_ptable_row:N \l_tmpb_clist 
								\c_alignment_token
								\elements_ita_ptable_row:N \l_tmpa_clist 
							}
						\tex_cr:D
					}
				\bottomrule
			\endtabular
		\group_end:
	}

% #1 -> clist with elements
\cs_set:Nn \elements_ita_ptable_row:N
	{
		\clist_gpop:NNT #1 \l_tmpa_tl
			{
				\tl_gset_eq:NN \g_tmpa_tl \l_tmpa_tl
				\chemmacros_chemformula:x 
					{ \elements_get_property_Z:Vn \g_tmpa_tl {symbol} } 
				\c_alignment_token
				\tl_use:N \g_tmpa_tl
				\c_alignment_token
				\elements_get_property_Z:Vn \g_tmpa_tl {mass}
			}
	}

\cs_generate_variant:Nn \elements_get_property_Z:nn {Vn}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   PRINT PERIODIC TABLE ELEMENT           
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\keys_define:nn { mendeleev/ptable }
	{
		%% PTABLE COLOR
		property .tl_set:N  = \l_ptable_property_tl ,
		property .initial:n = mass,

		%% PTABLE COLOR
		color .code:n    = { \color_set_eq:nn {ptable-color} {#1} } ,
		color .initial:n = black,

		%% PTABLE BOX SIZE
		size .dim_set:N = \l_ptable_box_size_dim,
		size .initial:n = 3.2em,

		%% PTABLE SCALE
		scale .fp_set:N = \l_ptable_box_scale_fp,
		scale .initial:n = 1.0,

		%% PTABLE BOX SIZE
		line-width .dim_set:N = \l_ptable_line_width_dim,
		line-width .initial:n = 0.4pt,

		%% PTABLE ELEMENT FONT
		symbol-font .tl_set:N  = \l_ptable_symbol_font_tl,
		symbol-font .initial:n = \large\bfseries\sffamily,

		%% PTABLE NUMBER FONT
		number-font .tl_set:N  = \l_ptable_number_font_tl,
		number-font .initial:n = \mdseries\scriptsize\sffamily,

		%% PTABLE PROPERTY FONT 
		property-font .tl_set:N  = \l_ptable_property_font_tl,
		property-font .initial:n = \mdseries\scriptsize\sffamily,
	}

%============================================================%
%   PERIODIC TABLE ELEMENT
%============================================================%

\coffin_new:N \l_ptable_element_coffin

\cs_set:Nn \ptable_element:nn
{
	\color_group_begin:

	\dim_set:Nn \l_ptable_box_size_dim {3.2em}
	\IfNoValueF{#1}{ \keys_set:nn {mendeleev/ptable} {#1} }
	\color_select:n {ptable-color}	

	\ptable_element_coffin:n {#2}

	\coffin_typeset:Nnnnn \l_ptable_element_coffin {l}{vc}{0pt}{+1ex}

	\color_group_end:
}

\cs_set:Nn \ptable_element_coffin:n
{
	\hcoffin_set:Nn \l_ptable_element_coffin
	{
		\draw_begin:
			\draw_linewidth:n { \l_ptable_line_width_dim }
			\draw_path_rectangle:nn
			{ 0cm , 0cm }
			{ \l_ptable_box_size_dim , \l_ptable_box_size_dim }
			\draw_path_use_clear:n { stroke }
		\draw_end:
	}

	\ptable_box_attach:nnnnnnnn {#1} {symbol} {hc}{vc}{hc}{vc}{0pt}{+0.2ex}
	\ptable_box_attach:nnnnnnnn {#1} {number} {l}{t}{l}{t}{+0.6ex}{-0.6ex}
	\ptable_box_attach:nVnnnnnn {#1} \l_ptable_property_tl {hc}{b}{hc}{H}{0pt}{+0.6ex}

	\coffin_scale:NVV \l_ptable_element_coffin \l_ptable_box_scale_fp \l_ptable_box_scale_fp
}

\cs_generate_variant:Nn \coffin_scale:Nnn {NVV}

%% ATTACH PARAMETERS

\coffin_new:N \l__ptable_tmp_coffin

% #1 -> element
% #2 -> property
% #3, #4, #5, #6, #7, #8 -> coffin attach parameters
\cs_set:Nn \ptable_box_attach:nnnnnnnn
{
	\hcoffin_set:Nn \l__ptable_tmp_coffin
	{
		\tl_if_exist:cTF {l_ptable_#2_font_tl}
			{ \tl_use:c {l_ptable_#2_font_tl} }
			{ \tl_use:N \l_ptable_property_font_tl }

		\GetElementProperty {#1}{#2} 
	}
	\coffin_attach:NnnNnnnn \l_ptable_element_coffin {#3}{#4} \l__ptable_tmp_coffin {#5}{#6}{#7}{#8}
}

\cs_generate_variant:Nn \ptable_box_attach:nnnnnnnn {nVnnnnnn}

%% FRONT-END

\NewDocumentCommand \PTableElement { o m }
{ \ptable_element:nn {#1}{#2} }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   PERIODIC TABLE ROW     
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\keys_define:nn { mendeleev/ptable/row }
	{
		%% PTABLE ROW SORTING
		sort .bool_set:N = \l_ptable_row_sort_bool,
		sort .initial:n  = true,
	}

%============================================================%
%   GENERATE PERIODIC TABLE ROW
%============================================================%

\coffin_new:N \l_ptable_row_coffin

% #1 -> ptable keys
% #2 -> clist with elements
\cs_set:Nn \ptable_row:nn
{	
	\color_group_begin:

	\clist_set:Nn \l_tmpa_clist {#2}

	\dim_set:Nn \l_ptable_box_size_dim {3.2em}
	\IfNoValueF{#1}{ \keys_set:nn {mendeleev/ptable} {#1} }
	\color_select:n {ptable-color}	

	\bool_if:NT \l_ptable_row_sort_bool
	{ \mendeleev_organize_elements:N \l_tmpa_clist  }

	\clist_map_inline:Nn \l_tmpa_clist
	{
		\ptable_element_coffin:n {##1}
	
		\coffin_join:NnnNnnnn \l_ptable_row_coffin {r}{H} \l_ptable_element_coffin {l}{H} {-\l_ptable_line_width_dim}{0pt}
	}
		
    \coffin_typeset:Nnnnn \l_ptable_row_coffin {l}{vc}{0pt}{+1ex}

	\color_group_end:
}
\cs_generate_variant:Nn \ptable_row:nn {nV}

%% FRONT-END

\NewDocumentCommand \PTableRow
{ o m } { \ptable_row:nn {#1} {#2} }

\NewDocumentCommand \PTableRowExpand
{ o m } { \ptable_row:nx {#1} {#2} }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   CALCULATE MOLAR MASS  
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\file_input:n { mendeleev.stoichiometry.sty }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   THE END!!!
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%