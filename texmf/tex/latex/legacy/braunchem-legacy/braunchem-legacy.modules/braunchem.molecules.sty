%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   CHEMISTRY FILE IDENTIFICATION                        
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ProvidesExplFile{molecules}{2019/10/11}{beta}{ Chemistry molecules }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   MOLECULE COMMAND                
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 

%============================================================%
%   GERNERAL STACK KEYS
%============================================================%

\keys_define:nn { molecules }
{
    align      .tl_set:N    = \l_molecule_align_tl,
    yshift     .dim_set:N   = \l_molecule_yshift_dim,
    fontsize   .dim_set:N   = \l_molecule_fontsize_dim,
    path       .tl_set:N    = \g_braunchem_molecule_path_tl,

    % INITIAL VALUES

    align      .initial:n   = vc,
    yshift     .initial:n   = 0pt,
    fontsize   .initial:n   = 10pt,
    path       .initial:n   = {}   
}

\NewDocumentCommand \MoleculeSet
{ m }
{
    \keys_set:nn { molecules } { #1 }    
}

\coffin_new:N \l_molecule_coffin

%============================================================%
%   MOLECULE COMMAND DEFINITION
%============================================================%

\NewDocumentCommand \moldraw
{ s O{} m o d() }
{
    \group_begin:

        \keys_set:nn { molecules } { #2 }   

        \hcoffin_set:Nn  \l_molecule_coffin 
        {
            \IfBooleanTF {#1}
            {
                \chemfig{#3}
            }
            {
                \includegraphics[scale = \fp_eval:n{ \dim_ratio:nn  { \f@size pt } { \l_molecule_fontsize_dim }} ]{\g_braunchem_molecule_path_tl #3}
            }
        }

        \molecule_box:nn { #5 } { #4 }

        \coffin_typeset:NnVnn
        \l_molecule_coffin {l} \l_molecule_align_tl {0pt} {\l_molecule_yshift_dim}

    \group_end:
}

\cs_generate_variant:Nn \coffin_typeset:Nnnnn { NnVnn }

%============================================================%
%   DECORATIONS
%============================================================%

\cs_new:Nn \molecule_box:nn
{
    \dim_set:Nn \l_tmpa_dim { \coffin_wd:N \l_molecule_coffin + 1.5em }
    \dim_set:Nn \l_tmpb_dim { \coffin_ht:N \l_molecule_coffin + \coffin_dp:N \l_molecule_coffin + 1.5em }

    %% Draw box

    \hcoffin_set:Nn \l_tmpa_coffin
    { \prop_item:Nn \l_molecule_box_styles_prop { #1 } }

    %% Draw name

    \hcoffin_set:Nn \l_tmpb_coffin
    { \IfNoValueF{#2}{ \colorbox{white}{\sffamily #2} } }

    %% Join coffins

    \IfNoValueTF{#1}
    {
        \coffin_join:NnnNnnnn
        \l_molecule_coffin {hc} {b} \l_tmpb_coffin {hc} {t} {0pt} {-1ex}
    }
    {
        \coffin_attach:NnnNnnnn
        \l_tmpa_coffin {hc} {b} \l_tmpb_coffin {hc} {vc} {0pt} {0pt}

        \coffin_join:NnnNnnnn
        \l_tmpa_coffin {\l_tmpa_coffin-hc} {\l_tmpa_coffin-vc} \l_molecule_coffin {hc} {vc}  {0pt} {0pt}
        \coffin_set_eq:NN \l_molecule_coffin \l_tmpa_coffin
    }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   MOLECULE BOX STYLES             
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\prop_new:N \l_molecule_box_styles_prop

\usetikzlibrary{shadows}

%============================================================%
%   STANDARD BOX
%============================================================%

\prop_put:Nnn \l_molecule_box_styles_prop
{ box }
{
    \tikzpicture
        \draw [ chemline, draw = Gray!50!Black , rounded~corners ] 
            ( 0 , 0 ) rectangle ( \tikz_dim:N \l_tmpa_dim , \tikz_dim:N \l_tmpb_dim );
    \endtikzpicture 
}

%============================================================%
%   BRACKETS
%============================================================%

\dim_const:Nn \c_bracket_dim { 0.5 em }

\prop_put:Nnn \l_molecule_box_styles_prop
{ brackets }
{
    \tikzpicture
        \draw [ chemline ] 
            ( \tikz_dim:N \c_bracket_dim , 0 ) -- ( 0 , 0 ) -- 
            ( 0 , \tikz_dim:N \l_tmpb_dim )    -- ( \tikz_dim:N \c_bracket_dim , \tikz_dim:N \l_tmpb_dim );
        \draw [ chemline ] 
            ( \tikz_dim:N \l_tmpa_dim - \tikz_dim:N \c_bracket_dim , 0 ) -- ( \tikz_dim:N \l_tmpa_dim , 0 ) -- 
            ( \tikz_dim:N \l_tmpa_dim , \tikz_dim:N \l_tmpb_dim ) -- 
            ( \tikz_dim:N \l_tmpa_dim - \tikz_dim:N \c_bracket_dim , \tikz_dim:N \l_tmpb_dim );
    \endtikzpicture 
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                              
%   THE END!!!
%                                              
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%